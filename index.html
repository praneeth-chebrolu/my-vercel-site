<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>OSF Cancer Clinical Trials | Trial List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 60px auto;
      padding: 0 20px;
      line-height: 1.6;
      color: #1f2937;
    }
    header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 24px;
    }
    nav a {
      margin-left: 14px;
      text-decoration: none;
      color: #1f2937;
    }
    nav a:hover { text-decoration: underline; }

    .card {
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 18px;
      margin-top: 16px;
      background: #ffffff;
    }

    .filters {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    input, select {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #ffffff;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 14px;
      margin-top: 14px;
    }

    .trial {
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 14px;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 220px;
    }

    .badgeRow { display: flex; gap: 8px; flex-wrap: wrap; }
    .badge {
      font-size: 12px;
      border: 1px solid #d1d5db;
      border-radius: 999px;
      padding: 4px 10px;
      background: #f9fafb;
    }

    button {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: pointer;
      font-weight: 600;
      text-align: left;
    }
    button:hover { background: #f3f4f6; }

    .actions {
      margin-top: auto;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .muted { color: #6b7280; font-size: 14px; }

    @media (max-width: 900px) {
      .filters { grid-template-columns: 1fr; }
      .grid { grid-template-columns: 1fr; }
    }

    .modalBackdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }

    .modal {
      width: 100%;
      max-width: 700px;
      background: white;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      padding: 18px;
    }

    .modalHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .closeBtn {
      width: auto;
      text-align: center;
    }
  </style>
</head>
<body>
  <header>
    <h1>OSF Cancer Clinical Trials</h1>
  <nav>
  <a href="index.html">Trial List</a>
  <a href="intake.html">Intake</a>
</nav>
    
  </header>

  <section class="card">
    <h2>Choose a trial</h2>
    <p class="muted">Filter the list below, then click “View details” for eligibility and contact info.</p>

    <div class="filters">
      <input id="q" placeholder="Search (keyword, ID, drug, cancer type)" />
      <select id="cancer">
        <option value="">All cancer types</option>
        <option>GBM</option>
        <option>Ovarian</option>
        <option>Lung</option>
        <option>Breast</option>
      </select>
      <select id="status">
        <option value="">All statuses</option>
        <option value="Recruiting">Recruiting</option>
        <option value="Not yet recruiting">Not yet recruiting</option>
      </select>
    </div>

    <div id="results" class="grid"></div>
    <p id="count" class="muted"></p>
  </section>

  <div id="backdrop" class="modalBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <h3 id="mTitle" style="margin:0;"></h3>
        <button id="close" class="closeBtn">Close</button>
      </div>
      <div id="mBody" class="muted"></div>
      <div style="margin-top:14px;">
        <a id="mLink" href="#" target="_blank" rel="noreferrer">Open trial link</a>
      </div>
    </div>
  </div>

  <script>
    // Replace these with YOUR real trials (your "list")
    // 1) Only store NCT + your local OSF details here
const TRIALS = [
  {
    nctId: "NCT06890338",
    local: {
      cancer: "Ovarian",
      location: "Peoria, IL",
      principalInvestigator: "Michelle Rowland, MD, PhD, MPH.",
      coordinator: "Lisa Gale, MSN, RN, CCRC",
      osfContactPhone: "(844) 673-4467",
      osfContactEmail: "sfmc.clinicaltrials@osfhealthcare.org"
    }
  },

  // Keep your custom, non NCT trials as-is if you want
  // (They will skip the CTgov fetch.)
  {
    id: "OSF-GBM-001",
    title: "GBM: Novel therapy + standard of care",
    cancer: "GBM",
    phase: "Phase 2",
    status: "Recruiting",
    location: "Peoria, IL",
    summary: "Evaluates safety and efficacy of a novel agent combined with standard therapy.",
    keyEligibility: [
      "Adult patients with confirmed GBM",
      "Measurable disease",
      "Adequate organ function"
    ],
    contact: "Research Coordinator: trials@example.com",
    link: "https://clinicaltrials.gov/"
  }
];

// ---------- Existing element lookups ----------
const qEl = document.getElementById("q");
const cancerEl = document.getElementById("cancer");
const statusEl = document.getElementById("status");
const resultsEl = document.getElementById("results");
const countEl = document.getElementById("count");

const backdrop = document.getElementById("backdrop");
const closeBtn = document.getElementById("close");
const mTitle = document.getElementById("mTitle");
const mBody = document.getElementById("mBody");
const mLink = document.getElementById("mLink");

// ---------- NEW: Fetch CTgov by NCT ----------
async function fetchStudyByNct(nctId) {
  const url = `https://clinicaltrials.gov/api/v2/studies/${encodeURIComponent(nctId)}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`ClinicalTrials.gov error ${res.status}`);
  return await res.json();
}

// ---------- NEW: Convert CTgov JSON into your card format ----------
function toTrialCardFromCtgov(study, local = {}) {
  const protocol = study.protocolSection || {};
  const idMod = protocol.identificationModule || {};
  const statusMod = protocol.statusModule || {};
  const sponsorMod = protocol.sponsorCollaboratorsModule || {};
  const descMod = protocol.descriptionModule || {};
  const designMod = protocol.designModule || {};
  const condMod = protocol.conditionsModule || {};
  const eligMod = protocol.eligibilityModule || {};

  const phases = Array.isArray(designMod.phases) ? designMod.phases : [];
  const phaseText = phases.length ? phases.join(", ").replaceAll("_", " ") : "Phase not listed";

  const overallStatus = (statusMod.overallStatus || "Status not listed").replaceAll("_", " ");

  const title = idMod.officialTitle || idMod.briefTitle || "Title not listed";

  const sponsorName = sponsorMod.leadSponsor?.name || "Sponsor not listed";

  // CTgov often has a big eligibility string. We keep it as a single item.
  const eligibilityText = eligMod.eligibilityCriteria || "Eligibility criteria not listed on ClinicalTrials.gov.";

  return {
    id: idMod.nctId || local.nctId || "NCT",
    title,
    cancer: local.cancer || (condMod.conditions?.[0] || "Cancer"),
    phase: local.phase || phaseText,
    status: local.status || overallStatus,
    location: local.location || "Location not listed",
    summary: descMod.briefSummary || "Summary not listed",
    keyEligibility: [eligibilityText],
    contact: [
      `Sponsor: ${sponsorName}`,
      local.principalInvestigator ? `PI: ${local.principalInvestigator}` : "",
      local.coordinator ? `CRC: ${local.coordinator}` : "",
      local.osfContactPhone ? `OSF Clinical Trials: ${local.osfContactPhone}` : "",
      local.osfContactEmail ? local.osfContactEmail : ""
    ].filter(Boolean).join(" | "),
    link: `https://clinicaltrials.gov/study/${idMod.nctId || local.nctId || ""}`
  };
}

// ---------- NEW: Expand TRIALS into fully populated list ----------
let EXPANDED_TRIALS = [];

async function expandTrials() {
  const expanded = [];

  for (const t of TRIALS) {
    // If it's already a full object (custom trial), keep it
    if (t.id && t.title) {
      expanded.push(t);
      continue;
    }

    // If it's an NCT entry, fetch from CTgov
    if (t.nctId) {
      try {
        const study = await fetchStudyByNct(t.nctId);
        expanded.push(toTrialCardFromCtgov(study, { ...(t.local || {}), nctId: t.nctId }));
      } catch (e) {
        expanded.push({
          id: t.nctId,
          title: `Could not load ${t.nctId}`,
          cancer: t.local?.cancer || "Cancer",
          phase: "Unknown",
          status: "Unknown",
          location: t.local?.location || "Unknown",
          summary: "There was a problem loading details from ClinicalTrials.gov. Please try again later.",
          keyEligibility: ["Not available"],
          contact: [
            t.local?.principalInvestigator ? `PI: ${t.local.principalInvestigator}` : "",
            t.local?.coordinator ? `CRC: ${t.local.coordinator}` : "",
            t.local?.osfContactPhone ? `OSF Clinical Trials: ${t.local.osfContactPhone}` : "",
            t.local?.osfContactEmail ? t.local.osfContactEmail : ""
          ].filter(Boolean).join(" | "),
          link: `https://clinicaltrials.gov/study/${t.nctId}`
        });
      }
    }
  }

  EXPANDED_TRIALS = expanded;
}

// ---------- Existing match logic, but use expanded trials ----------
function matches(trial) {
  const q = (qEl.value || "").toLowerCase().trim();
  const c = cancerEl.value;
  const s = statusEl.value;

  const text = [
    trial.id, trial.title, trial.cancer, trial.phase, trial.status,
    trial.location, trial.summary
  ].join(" ").toLowerCase();

  if (q && !text.includes(q)) return false;
  if (c && trial.cancer !== c) return false;
  if (s && trial.status !== s) return false;
  return true;
}

// ---------- UPDATED: render now works off EXPANDED_TRIALS ----------
function render() {
  const filtered = EXPANDED_TRIALS.filter(matches);

  resultsEl.innerHTML = filtered.map(t => `
    <div class="trial">
      <div class="badgeRow">
        <span class="badge">${t.cancer}</span>
        <span class="badge">${t.phase}</span>
        <span class="badge">${t.status}</span>
      </div>
      <div>
        <div style="font-weight:700; font-size:16px;">${t.title}</div>
        <div class="muted">${t.id} • ${t.location}</div>
      </div>
      <div class="muted">${t.summary}</div>
      <div class="actions">
        <button type="button" onclick="openModal('${t.id}')">View details</button>
        <a href="intake.html?trial=${encodeURIComponent(t.id)}#about">I’m interested</a>
      </div>
    </div>
  `).join("");

  countEl.textContent = `${filtered.length} trial(s) shown.`;
}

// ---------- UPDATED: modal pulls from EXPANDED_TRIALS ----------
window.openModal = function(id) {
  const t = EXPANDED_TRIALS.find(x => x.id === id);
  if (!t) return;

  mTitle.textContent = `${t.title} (${t.id})`;
  mBody.innerHTML = `
    <div><strong>Cancer:</strong> ${t.cancer}</div>
    <div><strong>Phase:</strong> ${t.phase}</div>
    <div><strong>Status:</strong> ${t.status}</div>
    <div><strong>Location:</strong> ${t.location}</div>
    <div style="margin-top:10px;"><strong>Summary:</strong> ${t.summary}</div>
    <div style="margin-top:10px;"><strong>Eligibility:</strong>
      <pre style="white-space:pre-wrap; font-family:inherit;">${t.keyEligibility[0]}</pre>
    </div>
    <div style="margin-top:10px;"><strong>Contact:</strong> ${t.contact}</div>
  `;
  mLink.href = t.link;

  backdrop.style.display = "flex";
};

function closeModal() {
  backdrop.style.display = "none";
}

closeBtn.addEventListener("click", closeModal);
backdrop.addEventListener("click", (e) => {
  if (e.target === backdrop) closeModal();
});

qEl.addEventListener("input", render);
cancerEl.addEventListener("change", render);
statusEl.addEventListener("change", render);

// ---------- NEW: load CTgov data first, then render ----------
(async function init() {
  resultsEl.innerHTML = `<div class="muted">Loading trials…</div>`;
  countEl.textContent = "";
  await expandTrials();
  render();
})();
  </script>
</body>
</html>

