<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>OSF Cancer Clinical Trials | Trial List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 60px auto;
      padding: 0 20px;
      line-height: 1.6;
      color: #1f2937;
    }
    header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 24px;
    }
    nav a {
      margin-left: 14px;
      text-decoration: none;
      color: #1f2937;
    }
    nav a:hover { text-decoration: underline; }

    .card {
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 18px;
      margin-top: 16px;
      background: #ffffff;
    }

    .filters {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    input, select {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #ffffff;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 14px;
      margin-top: 14px;
    }

    .trial {
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 14px;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 220px;
    }

    .badgeRow { display: flex; gap: 8px; flex-wrap: wrap; }
    .badge {
      font-size: 12px;
      border: 1px solid #d1d5db;
      border-radius: 999px;
      padding: 4px 10px;
      background: #f9fafb;
    }

    /* REVERSED COLORS (as requested):
       Recruiting = RED
       Everything else = GREEN
    */
    .badge.status-recruiting{
      background:#fef2f2;
      border-color:#ef4444;
      color:#7f1d1d;
    }
    .badge.status-not-recruiting{
      background:#ecfdf5;
      border-color:#10b981;
      color:#065f46;
    }

    button {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: pointer;
      font-weight: 600;
      text-align: left;
    }
    button:hover { background: #f3f4f6; }

    .actions {
      margin-top: auto;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .muted { color: #6b7280; font-size: 14px; }

    @media (max-width: 900px) {
      .filters { grid-template-columns: 1fr; }
      .grid { grid-template-columns: 1fr; }
    }

    .modalBackdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }

    .modal {
      width: 100%;
      max-width: 700px;
      background: white;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      padding: 18px;
    }

    .modalHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .closeBtn {
      width: auto;
      text-align: center;
    }
  </style>
</head>

<body>
  <header>
    <h1>OSF Cancer Clinical Trials</h1>
    <nav>
      <a href="index.html">Trial List</a>
      <a href="intake.html">Intake</a>
    </nav>
  </header>

  <section class="card">
    <h2>Choose a trial</h2>
    <p class="muted">Filter the list below, then click “View details” for eligibility and contact info.</p>

    <div class="filters">
      <input id="q" placeholder="Search (keyword, ID, drug, cancer type)" />
      <select id="cancer">
        <option value="">All cancer types</option>
        <option>GBM</option>
        <option>Ovarian</option>
        <option>Lung</option>
        <option>Breast</option>
      </select>
      <select id="status">
        <option value="">All statuses</option>
        <option value="Recruiting">Recruiting</option>
        <option value="Not yet recruiting">Not yet recruiting</option>
        <option value="Active, not recruiting">Active, not recruiting</option>
        <option value="Completed">Completed</option>
      </select>
    </div>

    <div id="results" class="grid"></div>
    <p id="count" class="muted"></p>
  </section>

  <div id="backdrop" class="modalBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <h3 id="mTitle" style="margin:0;"></h3>
        <button id="close" class="closeBtn">Close</button>
      </div>
      <div id="mBody" class="muted"></div>
      <div style="margin-top:14px;">
        <a id="mLink" href="#" target="_blank" rel="noreferrer">Open trial link</a>
      </div>
    </div>
  </div>

  <script>
    // =========================================================
    // TRIAL LIST: Pull trials from YOUR CSV, then enrich from ClinicalTrials.gov
    // - Patient-friendly Overview: max 4 bullets (no status repeated there)
    // - Status badge colors are reversed: Recruiting = red, others = green
    // - Eligibility: Inclusion/Exclusion parsed; subpoints shown without bullets
    // =========================================================

    // ✅ Paste your GitHub RAW CSV URL here:
    const CSV_URL = "https://raw.githubusercontent.com/praneeth-chebrolu/my-vercel-site/main/Webpage%20Listing_OSF%20Cancer%20Clinical%20Trials.csv";

    // --------------- DOM elements ---------------
    const qEl = document.getElementById("q");
    const cancerEl = document.getElementById("cancer");
    const statusEl = document.getElementById("status");
    const resultsEl = document.getElementById("results");
    const countEl = document.getElementById("count");

    const backdrop = document.getElementById("backdrop");
    const closeBtn = document.getElementById("close");
    const mTitle = document.getElementById("mTitle");
    const mBody = document.getElementById("mBody");
    const mLink = document.getElementById("mLink");

    // --------------- Helpers ---------------
    function cleanText(s) {
      return (s || "").replace(/\s+/g, " ").trim();
    }

    function firstNonEmpty(...vals) {
      for (const v of vals) {
        if (typeof v === "string" && v.trim()) return v.trim();
      }
      return "";
    }

    function listNames(arr, key = "name", max = 4) {
      if (!Array.isArray(arr)) return [];
      return arr
        .map(x => (typeof x === "string" ? x : x?.[key]))
        .filter(Boolean)
        .map(x => cleanText(x))
        .slice(0, max);
    }

    function getPhaseText(designMod) {
      const phases = Array.isArray(designMod?.phases) ? designMod.phases : [];
      return phases.length ? phases.join(", ").replaceAll("_", " ") : "Phase not listed";
    }

    function getSponsorText(sponsorMod) {
      const lead = sponsorMod?.leadSponsor?.name;
      const cols = Array.isArray(sponsorMod?.collaborators)
        ? sponsorMod.collaborators.map(c => c?.name).filter(Boolean)
        : [];
      const all = [lead, ...cols].filter(Boolean);
      return all.length ? all.join(" / ") : "Sponsor not listed";
    }

    function getInterventionSummary(armsInterventionsMod, interventionsMod) {
      const names = listNames(interventionsMod?.interventions, "name", 4);
      if (names.length) return names.join(", ");
      const armLabels = listNames(armsInterventionsMod?.armGroups, "label", 2);
      if (armLabels.length) return armLabels.join(", ");
      return "";
    }

    // --------------- Status class helper (REVERSED COLORS) ---------------
    function statusClass(statusText) {
      return statusText === "Recruiting" ? "status-recruiting" : "status-not-recruiting";
    }

    // --------------- Patient-friendly Study Overview (max 4 bullets) ---------------
    function makePatientOverview({ phase, diseaseFocus, interventionsSummary }) {
      const bullets = [];

      if (phase && phase !== "Phase not listed") {
        bullets.push(`This is a ${phase} clinical trial studying a treatment approach.`);
      } else {
        bullets.push("This is a clinical trial studying a treatment approach.");
      }

      if (diseaseFocus) {
        bullets.push(`This study is for people with ${diseaseFocus}.`);
      } else {
        bullets.push("This study is for people with the condition listed in the trial details.");
      }

      bullets.push("The goal is to learn whether the treatment is safe and how well it works.");

      if (interventionsSummary) {
        bullets.push(`People in the study may receive ${interventionsSummary}. The study team will explain the visit schedule, tests, and next steps.`);
      } else {
        bullets.push("People in the study may receive study treatment. The study team will explain the visit schedule, tests, and next steps.");
      }

      return bullets.slice(0, 4);
    }

    // --------------- Eligibility parsing (no bullets for subpoints) ---------------
    function parseEligibilityCriteria(raw) {
      const text = (raw || "").replace(/\r/g, "");
      if (!text.trim()) return { inclusion: [], exclusion: [] };

      const lower = text.toLowerCase();
      const incIdx = lower.indexOf("inclusion criteria");
      const excIdx = lower.indexOf("exclusion criteria");

      let incText = "";
      let excText = "";

      if (incIdx !== -1 && excIdx !== -1) {
        if (incIdx < excIdx) {
          incText = text.slice(incIdx, excIdx);
          excText = text.slice(excIdx);
        } else {
          excText = text.slice(excIdx, incIdx);
          incText = text.slice(incIdx);
        }
      } else if (incIdx !== -1) {
        incText = text.slice(incIdx);
      } else if (excIdx !== -1) {
        excText = text.slice(excIdx);
      }

      function toBullets(sectionText) {
        const cleaned = sectionText
          .replace(/inclusion criteria[:\s]*/i, "")
          .replace(/exclusion criteria[:\s]*/i, "")
          .trim();

        if (!cleaned) return [];

        const lines = cleaned
          .split(/\n+/)
          .map(l => l.trim())
          .filter(Boolean);

        const items = [];
        let current = null;

        for (const line of lines) {
          const isSubPoint = /^[a-z]\)|^[-–•]/i.test(line) || line.startsWith("(");
          const text = line
            .replace(/^[-–•\s]*/, "")
            .replace(/^[a-z]\)\s*/i, "")
            .trim();

          if (!text) continue;

          if (isSubPoint && current) {
            current.sub.push(text);
          } else {
            if (current) items.push(current);
            current = { main: text, sub: [] };
          }
        }
        if (current) items.push(current);

        return items.slice(0, 6).map(b => {
          if (!b.sub.length) return b.main;
          return `${b.main}<br>${b.sub.map(s => `&nbsp;&nbsp;${s}`).join("<br>")}`;
        });
      }

      return {
        inclusion: toBullets(incText),
        exclusion: toBullets(excText)
      };
    }

    function getHighLevelWhoCanJoin({ diseaseFocus, eligibilityModule }) {
      const who = [];

      const minAge = eligibilityModule?.minimumAge;
      const maxAge = eligibilityModule?.maximumAge;
      const sex = eligibilityModule?.sex;

      if (minAge || maxAge) {
        const a = [];
        if (minAge) a.push(`at least ${minAge}`);
        if (maxAge) a.push(`up to ${maxAge}`);
        who.push(`Age: People who are ${a.join(" and ")}.`);
      }

      if (sex && sex !== "ALL") {
        who.push(`Sex: This study is only for ${sex.toLowerCase()} participants.`);
      }

      if (diseaseFocus) {
        who.push(`Condition: People diagnosed with ${diseaseFocus}.`);
      }

      const raw = eligibilityModule?.eligibilityCriteria || "";
      const parsed = parseEligibilityCriteria(raw);

      if (parsed.inclusion.length) {
        return [...who, ...parsed.inclusion].slice(0, 6);
      }

      who.push("Other eligibility rules apply. The study team will confirm eligibility.");
      return who.slice(0, 6);
    }

    function getHighLevelWhoCannotJoin({ eligibilityModule }) {
      const raw = eligibilityModule?.eligibilityCriteria || "";
      const parsed = parseEligibilityCriteria(raw);

      if (parsed.exclusion.length) {
        return parsed.exclusion.slice(0, 6);
      }

      return [
        "People who do not meet the study’s eligibility requirements.",
        "The study team will confirm eligibility after review."
      ];
    }

    // ===============================
    // Load trials from CSV (YOUR Excel headers)
    // Expected columns:
    // NCT ID, Cancer, Principal Investigator, Clinical Research Coordinator, Status
    // ===============================
    async function loadTrialsFromCSV(csvUrl) {
      const response = await fetch(csvUrl);
      const csvText = await response.text();

      const rows = csvText
        .split("\n")
        .map(r => r.trim())
        .filter(r => r.length);

      const headers = rows
        .shift()
        .split(",")
        .map(h => h.replace(/^"|"$/g, "").trim());

      function get(record, key) {
        if (record[key] != null) return record[key];

        const normKey = key.replace(/\s+/g, " ").trim().toLowerCase();
        for (const k of Object.keys(record)) {
          const nk = k.replace(/\s+/g, " ").trim().toLowerCase();
          if (nk === normKey) return record[k];
        }
        return "";
      }

      return rows
        .map(row => {
          const values = row
            .split(",")
            .map(v => v.replace(/^"|"$/g, "").trim());

          const record = {};
          headers.forEach((h, i) => {
            record[h] = values[i] || "";
          });

          const nctId = get(record, "NCT ID");
          const cancer = get(record, "Cancer");
          const principalInvestigator = get(record, "Principal Investigator");
          const coordinator = get(record, "Clinical Research Coordinator");
          const statusOverride = get(record, "Status");

          return {
            nctId,
            local: {
              cancer,
              diseaseFocus: "",
              principalInvestigator,
              coordinator,
              statusOverride,
              osfPhone: "(844) 673-4467",
              osfEmail: "sfmc.clinicaltrials@osfhealthcare.org",
              overviewBullets: [],
              whoCanJoin: [],
              whoCannotJoin: []
            }
          };
        })
        .filter(t => t.nctId);
    }

    // ===============================
    // Fetch ClinicalTrials.gov study
    // ===============================
    async function fetchCtgovStudy(nctId) {
      const url = `https://clinicaltrials.gov/api/v2/studies/${encodeURIComponent(nctId)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`ClinicalTrials.gov error ${res.status}`);
      return await res.json();
    }

    // --------------- Convert CT.gov -> model ---------------
    function toTrialModel(study, local, nctId) {
      const p = study.protocolSection || {};
      const idMod = p.identificationModule || {};
      const statusMod = p.statusModule || {};
      const sponsorMod = p.sponsorCollaboratorsModule || {};
      const designMod = p.designModule || {};
      const condMod = p.conditionsModule || {};
      const armsInterventionsMod = p.armsInterventionsModule || {};
      const interventionsMod = p.interventionsModule || {};
      const descMod = p.descriptionModule || {};
      const eligMod = p.eligibilityModule || {};

      const ctgovId = idMod.nctId || nctId;
      const ctgovLink = `https://clinicaltrials.gov/study/${ctgovId}`;

      const title = firstNonEmpty(idMod.officialTitle, idMod.briefTitle, "Title not listed");
      const phase = getPhaseText(designMod);
      const sponsor = getSponsorText(sponsorMod);

      // status from CT.gov (kept for filtering + display)
      const status = (statusMod.overallStatus || "Status not listed").replaceAll("_", " ");

      const defaultCondition =
        (Array.isArray(condMod.conditions) && condMod.conditions.length) ? condMod.conditions[0] : "Cancer";

      const cancerBadge = local.cancer || defaultCondition;
      const diseaseFocus = local.diseaseFocus || defaultCondition;

      const interventionsSummary = getInterventionSummary(armsInterventionsMod, interventionsMod);

      const overviewBullets =
        Array.isArray(local.overviewBullets) && local.overviewBullets.length
          ? local.overviewBullets.slice(0, 4)
          : makePatientOverview({ phase, diseaseFocus, interventionsSummary });

      const whoCanJoin =
        Array.isArray(local.whoCanJoin) && local.whoCanJoin.length
          ? local.whoCanJoin
          : getHighLevelWhoCanJoin({ diseaseFocus, eligibilityModule: eligMod });

      const whoCannotJoin =
        Array.isArray(local.whoCannotJoin) && local.whoCannotJoin.length
          ? local.whoCannotJoin
          : getHighLevelWhoCannotJoin({ eligibilityModule: eligMod });

      const note =
        local.note ||
        "Eligibility shown here is high-level and not complete. Final eligibility is determined by the study team after review in coordination with your cancer care team.";

      return {
        id: ctgovId,
        ctgovLink,

        // Card fields
        title,
        cancer: cancerBadge,
        phase,
        status,
        sponsor,

        // Modal fields
        diseaseFocus,

        // Local OSF fields
        principalInvestigator: local.principalInvestigator || "",
        coordinator: local.coordinator || "",
        osfPhone: local.osfPhone || "",
        osfEmail: local.osfEmail || "",

        // Patient-friendly content
        overviewBullets,
        whoCanJoin,
        whoCannotJoin,
        note
      };
    }

    // --------------- App state ---------------
    let EXPANDED_TRIALS = [];

    // ✅ Load from CSV, then enrich from CT.gov
    async function loadTrials() {
      const spreadsheetTrials = await loadTrialsFromCSV(CSV_URL);

      const expanded = [];
      for (const t of spreadsheetTrials) {
        const study = await fetchCtgovStudy(t.nctId);
        expanded.push(toTrialModel(study, t.local || {}, t.nctId));
      }

      EXPANDED_TRIALS = expanded;
    }

    // --------------- Filter logic ---------------
    function matches(trial) {
      const q = (qEl.value || "").toLowerCase().trim();
      const c = cancerEl.value;
      const s = statusEl.value;

      const text = [
        trial.id,
        trial.title,
        trial.cancer,
        trial.phase,
        trial.status,
        trial.sponsor,
        trial.diseaseFocus
      ].join(" ").toLowerCase();

      if (q && !text.includes(q)) return false;
      if (c && trial.cancer !== c) return false;
      if (s && trial.status !== s) return false;
      return true;
    }

    // --------------- Render ---------------
    function render() {
      const filtered = EXPANDED_TRIALS.filter(matches);

      resultsEl.innerHTML = filtered.map(t => `
        <div class="trial">
          <div class="badgeRow">
            <span class="badge">${t.cancer}</span>
            <span class="badge">${t.phase}</span>
            <span class="badge ${statusClass(t.status)}">${t.status}</span>
          </div>

          <div>
            <div style="font-weight:700; font-size:16px;">${t.title}</div>
            <div class="muted">
              <a href="${t.ctgovLink}" target="_blank" rel="noreferrer">${t.id}</a>
              • ${t.sponsor}
            </div>
          </div>

          <div class="actions">
            <button type="button" onclick="openModal('${t.id}')">View details</button>
            <a href="intake.html?trial=${encodeURIComponent(t.id)}#about">I’m interested</a>
          </div>
        </div>
      `).join("");

      countEl.textContent = `${filtered.length} trial(s) shown.`;
    }

    function bulletsToHtml(arr) {
      if (!arr || !arr.length) return "<div class='muted'>Not listed.</div>";
      return `<ul>${arr.map(x => `<li>${x}</li>`).join("")}</ul>`;
    }

    // --------------- Modal ---------------
    window.openModal = function(id) {
      const t = EXPANDED_TRIALS.find(x => x.id === id);
      if (!t) return;

      mTitle.textContent = `${t.title} (${t.id})`;

      mBody.innerHTML = `
        <div><strong>Cancer:</strong> ${t.cancer}</div>
        <div><strong>Study Phase:</strong> ${t.phase}</div>
        <div><strong>Status:</strong> <span class="badge ${statusClass(t.status)}">${t.status}</span></div>
        <div><strong>Sponsor:</strong> ${t.sponsor}</div>

        <div style="margin-top:10px;">
          <strong>ClinicalTrials.gov Identifier:</strong>
          <a href="${t.ctgovLink}" target="_blank" rel="noreferrer">${t.id}</a>
        </div>

        <div style="margin-top:10px;"><strong>Disease Focus:</strong> ${t.diseaseFocus}</div>

        ${t.principalInvestigator ? `<div style="margin-top:10px;"><strong>Principal Investigator:</strong> ${t.principalInvestigator}</div>` : ""}
        ${t.coordinator ? `<div><strong>Clinical Research Coordinator:</strong> ${t.coordinator}</div>` : ""}

        <div style="margin-top:14px;"><strong>Study Overview</strong></div>
        ${bulletsToHtml(t.overviewBullets)}

        <div style="margin-top:14px;"><strong>Eligibility</strong></div>
        <div style="margin-top:10px;"><strong>Who Can Join This Study</strong></div>
        ${bulletsToHtml(t.whoCanJoin)}

        <div style="margin-top:10px;"><strong>Who Cannot Join</strong></div>
        ${bulletsToHtml(t.whoCannotJoin)}

        <div style="margin-top:10px;" class="muted"><strong>Note:</strong> ${t.note}</div>

        <div style="margin-top:14px;"><strong>How to contact</strong></div>
        <div>${t.osfPhone ? t.osfPhone : ""}${t.osfPhone && t.osfEmail ? " or " : ""}${t.osfEmail ? t.osfEmail : ""}</div>
      `;

      mLink.href = t.ctgovLink;
      backdrop.style.display = "flex";
    };

    function closeModal() {
      backdrop.style.display = "none";
    }

    closeBtn.addEventListener("click", closeModal);
    backdrop.addEventListener("click", (e) => {
      if (e.target === backdrop) closeModal();
    });

    qEl.addEventListener("input", render);
    cancerEl.addEventListener("change", render);
    statusEl.addEventListener("change", render);

    // --------------- Init ---------------
    (async function init() {
      resultsEl.innerHTML = `<div class="muted">Loading trials…</div>`;
      countEl.textContent = "";

      try {
        await loadTrials();
        render();
      } catch (e) {
        resultsEl.innerHTML = `<div class="muted">Could not load trials right now. Please refresh.</div>`;
        countEl.textContent = "";
        // Uncomment for debugging:
        // console.error(e);
      }
    })();
  </script>
</body>
</html>
