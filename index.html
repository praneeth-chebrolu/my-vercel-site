<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>OSF Cancer Clinical Trials | Trial List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 60px auto;
      padding: 0 20px;
      line-height: 1.6;
      color: #1f2937;
    }
    header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 24px;
    }
    nav a {
      margin-left: 14px;
      text-decoration: none;
      color: #1f2937;
    }
    nav a:hover { text-decoration: underline; }

    .card {
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 18px;
      margin-top: 16px;
      background: #ffffff;
    }

    .filters {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    input, select {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #ffffff;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 14px;
      margin-top: 14px;
    }

    .trial {
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 14px;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 220px;
    }

    .badgeRow { display: flex; gap: 8px; flex-wrap: wrap; }
    .badge {
      font-size: 12px;
      border: 1px solid #d1d5db;
      border-radius: 999px;
      padding: 4px 10px;
      background: #f9fafb;
    }

    button {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: pointer;
      font-weight: 600;
      text-align: left;
    }
    button:hover { background: #f3f4f6; }

    .actions {
      margin-top: auto;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .muted { color: #6b7280; font-size: 14px; }

    @media (max-width: 900px) {
      .filters { grid-template-columns: 1fr; }
      .grid { grid-template-columns: 1fr; }
    }

    .modalBackdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }

    .modal {
      width: 100%;
      max-width: 700px;
      background: white;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      padding: 18px;
    }

    .modalHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .closeBtn {
      width: auto;
      text-align: center;
    }
  </style>
</head>
<body>
  <header>
    <h1>OSF Cancer Clinical Trials</h1>
  <nav>
  <a href="index.html">Trial List</a>
  <a href="intake.html">Intake</a>
</nav>
    
  </header>

  <section class="card">
    <h2>Choose a trial</h2>
    <p class="muted">Filter the list below, then click “View details” for eligibility and contact info.</p>

    <div class="filters">
      <input id="q" placeholder="Search (keyword, ID, drug, cancer type)" />
      <select id="cancer">
        <option value="">All cancer types</option>
        <option>GBM</option>
        <option>Ovarian</option>
        <option>Lung</option>
        <option>Breast</option>
      </select>
      <select id="status">
        <option value="">All statuses</option>
        <option value="Recruiting">Recruiting</option>
        <option value="Not yet recruiting">Not yet recruiting</option>
      </select>
    </div>

    <div id="results" class="grid"></div>
    <p id="count" class="muted"></p>
  </section>

  <div id="backdrop" class="modalBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <h3 id="mTitle" style="margin:0;"></h3>
        <button id="close" class="closeBtn">Close</button>
      </div>
      <div id="mBody" class="muted"></div>
      <div style="margin-top:14px;">
        <a id="mLink" href="#" target="_blank" rel="noreferrer">Open trial link</a>
      </div>
    </div>
  </div>

  <script>
  // ============ 1) Trials: NCT + your local OSF fields ============
  // Add more trials by adding another object with nctId and local fields.
  const TRIALS = [
    {
      nctId: "NCT06890338",
      local: {
        cancer: "Ovarian",
        diseaseFocus: "Advanced stage Epithelial Ovarian, Fallopian Tube and Primary Peritoneal Cancers",
        principalInvestigator: "Michelle Rowland, MD, PhD, MPH.",
        coordinator: "Lisa Gale, MSN, RN, CCRC",
        osfPhone: "(844) 673- 4467",
        osfEmail: "sfmc.clinicaltrials@osfhealthcare.org",

        overviewBullets: [
          "This is a Phase II clinical trial testing a combination therapy.",
          "This study is for people with advanced ovarian, fallopian tube, or primary peritoneal cancer whose tumors have a protein called folate receptor alpha (FRα).",
          "The goal is to find out whether giving two medicines Mirvetuximab Soravtansine (MIRV) and Carboplatin before surgery is safe and effective in shrinking the cancer.",
          "In this study, MIRV is considered an experimental medicine and is being evaluated for its safety and effectiveness when given with carboplatin before surgery.",
          "In this study, participants will receive MIRV together with Carboplatin through an IV once every three weeks for up to 6 to 9 treatment cycles before surgery.",
          "About 140 adults will take part across 80 locations in the United States, and the study will last about three years.",
          "Participants will have regular clinic visits, blood tests, and scans as part of their care. The treatment and monitoring schedule may require more clinic visits than standard treatment."
        ],

        whoCanJoin: [
          "Adults 18 years and older with advanced (stage III or IV) ovarian, fallopian tube, or primary peritoneal cancer that is high-grade serous type and shows high folate receptor alpha (FRα) levels may be able to join.",
          "Participants must be in good overall health (ECOG 0–1) and",
          "Considered suitable by their doctor to receive chemotherapy before surgery."
        ],

        whoCannotJoin: [
          "Participants with other cancer types (like clear cell, mucinous, or low-grade tumors).",
          "Participants who received prior cancer treatments for this disease (except one carboplatin cycle)",
          "Participants with lung inflammation (pneumonitis), or serious eye conditions that affect vision cannot participate.",
          "Participants with another active cancer in the past 3 years are also not eligible, unless it was a minor, well-treated skin or in-situ cancer."
        ],

        note: "The eligibility listed above do not represent the complete list of criteria. Final eligibility will be determined by the study team after a complete review, in coordination with your cancer care team"
      }
    }
  ];

  // ============ 2) Existing element lookups ============
  const qEl = document.getElementById("q");
  const cancerEl = document.getElementById("cancer");
  const statusEl = document.getElementById("status");
  const resultsEl = document.getElementById("results");
  const countEl = document.getElementById("count");

  const backdrop = document.getElementById("backdrop");
  const closeBtn = document.getElementById("close");
  const mTitle = document.getElementById("mTitle");
  const mBody = document.getElementById("mBody");
  const mLink = document.getElementById("mLink");

  // ============ 3) Minimal CT.gov fetch (high-level fields only) ============
  async function fetchCtgovStudy(nctId) {
    const url = `https://clinicaltrials.gov/api/v2/studies/${encodeURIComponent(nctId)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`ClinicalTrials.gov error ${res.status}`);
    return await res.json();
  }

  // Convert CT.gov JSON -> high-level model used by your UI.
  function toHighLevelTrial(study, local, nctId) {
    const p = study.protocolSection || {};
    const id = p.identificationModule || {};
    const status = p.statusModule || {};
    const sponsor = p.sponsorCollaboratorsModule || {};
    const desc = p.descriptionModule || {};
    const design = p.designModule || {};
    const cond = p.conditionsModule || {};

    const title = id.officialTitle || id.briefTitle || "Title not listed";

    const phase = (Array.isArray(design.phases) && design.phases.length)
      ? design.phases.join(", ").replaceAll("_", " ")
      : "Phase not listed";

    const sponsorText = [
      sponsor.leadSponsor?.name,
      ...(Array.isArray(sponsor.collaborators) ? sponsor.collaborators.map(c => c.name) : [])
    ].filter(Boolean).join(" / ") || "Sponsor not listed";

    const overallStatus = (status.overallStatus || "Status not listed").replaceAll("_", " ");

    return {
      id: id.nctId || nctId,
      ctgovLink: `https://clinicaltrials.gov/study/${id.nctId || nctId}`,

      // What shows on cards
      title: title,
      cancer: local.cancer || (cond.conditions?.[0] || "Cancer"),
      phase: phase,
      status: overallStatus,
      sponsor: sponsorText,

      // Modal details
      diseaseFocus: local.diseaseFocus || (cond.conditions?.[0] || "Disease focus not listed"),
      summary: desc.briefSummary || "Summary not listed",

      principalInvestigator: local.principalInvestigator || "",
      coordinator: local.coordinator || "",
      osfPhone: local.osfPhone || "",
      osfEmail: local.osfEmail || "",

      overviewBullets: local.overviewBullets || [],
      whoCanJoin: local.whoCanJoin || [],
      whoCannotJoin: local.whoCannotJoin || [],
      note: local.note || ""
    };
  }

  let EXPANDED_TRIALS = [];

  async function loadTrials() {
    const expanded = [];
    for (const t of TRIALS) {
      const study = await fetchCtgovStudy(t.nctId);
      expanded.push(toHighLevelTrial(study, t.local || {}, t.nctId));
    }
    EXPANDED_TRIALS = expanded;
  }

  // ============ 4) Filtering ============
  function matches(trial) {
    const q = (qEl.value || "").toLowerCase().trim();
    const c = cancerEl.value;
    const s = statusEl.value;

    const text = [
      trial.id,
      trial.title,
      trial.cancer,
      trial.phase,
      trial.status,
      trial.sponsor,
      trial.diseaseFocus
    ].join(" ").toLowerCase();

    if (q && !text.includes(q)) return false;

    // Match cancer dropdown against trial.cancer (simple and consistent)
    if (c && trial.cancer !== c) return false;

    if (s && trial.status !== s) return false;

    return true;
  }

  // ============ 5) Render cards (Cancer + Phase + Status badges, NCT clickable) ============
  function render() {
    const filtered = EXPANDED_TRIALS.filter(matches);

    resultsEl.innerHTML = filtered.map(t => `
      <div class="trial">
        <div class="badgeRow">
          <span class="badge">${t.cancer}</span>
          <span class="badge">${t.phase}</span>
          <span class="badge">${t.status}</span>
        </div>

        <div>
          <div style="font-weight:700; font-size:16px;">${t.title}</div>
          <div class="muted">
            <a href="${t.ctgovLink}" target="_blank" rel="noreferrer">${t.id}</a>
            • ${t.sponsor}
          </div>
        </div>

        <div class="actions">
          <button type="button" onclick="openModal('${t.id}')">View details</button>
          <a href="intake.html?trial=${encodeURIComponent(t.id)}#about">I’m interested</a>
        </div>
      </div>
    `).join("");

    countEl.textContent = `${filtered.length} trial(s) shown.`;
  }

  // ============ 6) Modal ============
  function bulletsToHtml(arr) {
    if (!arr || !arr.length) return "<div class='muted'>Not listed.</div>";
    return `<ul>${arr.map(x => `<li>${x}</li>`).join("")}</ul>`;
  }

  window.openModal = function(id) {
    const t = EXPANDED_TRIALS.find(x => x.id === id);
    if (!t) return;

    mTitle.textContent = `${t.title} (${t.id})`;

    mBody.innerHTML = `
      <div><strong>Study Phase:</strong> ${t.phase}</div>
      <div><strong>Sponsor:</strong> ${t.sponsor}</div>
      <div>
        <strong>ClinicalTrials.gov Identifier:</strong>
        <a href="${t.ctgovLink}" target="_blank" rel="noreferrer">${t.id}</a>
      </div>
      <div><strong>Disease Focus:</strong> ${t.diseaseFocus}</div>

      <div style="margin-top:10px;"><strong>Principal Investigator:</strong> ${t.principalInvestigator}</div>
      <div><strong>Clinical Research Coordinator:</strong> ${t.coordinator}</div>

      <div style="margin-top:14px;"><strong>Study Overview</strong></div>
      ${bulletsToHtml(t.overviewBullets)}

      <div style="margin-top:14px;"><strong>Eligibility</strong></div>

      <div style="margin-top:10px;"><strong>Who Can Join This Study</strong></div>
      ${bulletsToHtml(t.whoCanJoin)}

      <div style="margin-top:10px;"><strong>Who Cannot Join</strong></div>
      ${bulletsToHtml(t.whoCannotJoin)}

      <div style="margin-top:10px;" class="muted"><strong>Note:</strong> ${t.note}</div>

      <div style="margin-top:14px;"><strong>Enrollment Information</strong></div>
      <div><strong>Status:</strong> ${t.status}</div>
      <div>See if you qualify. Contact us: ${t.osfPhone} (OR) Email: ${t.osfEmail}</div>
    `;

    mLink.href = t.ctgovLink;
    backdrop.style.display = "flex";
  };

  function closeModal() {
    backdrop.style.display = "none";
  }

  closeBtn.addEventListener("click", closeModal);
  backdrop.addEventListener("click", (e) => {
    if (e.target === backdrop) closeModal();
  });

  qEl.addEventListener("input", render);
  cancerEl.addEventListener("change", render);
  statusEl.addEventListener("change", render);

  // ============ 7) Init ============
  (async function init() {
    resultsEl.innerHTML = `<div class="muted">Loading trials…</div>`;
    countEl.textContent = "";
    try {
      await loadTrials();
      render();
    } catch (e) {
      resultsEl.innerHTML = `<div class="muted">Could not load trials right now. Please refresh.</div>`;
    }
  })();
</script>
</body>
</html>

